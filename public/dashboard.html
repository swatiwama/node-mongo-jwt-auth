<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="card p-4 mt-4">
    <div class="d-flex justify-content-between">
      <h3>Dashboard</h3>
      <div>
        <button id="logoutBtn" class="btn btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div id="userInfo" class="mt-3"></div>

    <h5 class="mt-4">Credits</h5>
    <div id="creditsPanel" class="mb-3">
      <strong>Remaining credits:</strong> <span id="creditsCount">...</span>
      <button id="useCreditBtn" class="btn btn-sm btn-warning ms-2">Use 1 Credit</button>
    </div>

    <h5>Transactions</h5>
    <div id="transactions">Loading...</div>
  </div>
</div>

<script>
const token = localStorage.getItem('token');
if (!token) { window.location = '/login.html'; }
const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };

async function loadProfile() {
  const r = await fetch('/api/auth/profile', { headers });
  if (!r.ok) { localStorage.removeItem('token'); window.location = '/login.html'; }
  const j = await r.json();
  const u = j.user;
  document.getElementById('userInfo').innerHTML = `<p>Hello, ${u.firstName} ${u.lastName} (<em>${u.username}</em>)</p>`;
  document.getElementById('creditsCount').innerText = u.credits;
}

async function loadTransactions() {
  const r = await fetch('/api/credits/transactions', { headers });
  const j = await r.json();
  const el = document.getElementById('transactions');
  if (!r.ok) { el.innerText = 'Unable to load'; return; }
  if (j.transactions.length === 0) { el.innerText = 'No transactions yet'; return; }
  el.innerHTML = '<ul class="list-group">' + j.transactions.map(tx => 
    `<li class="list-group-item">
       ${new Date(tx.createdAt).toLocaleString()} — ${tx.delta>0? '+'+tx.delta : tx.delta} — ${tx.type} ${tx.note?(' - ' + tx.note):''}
     </li>`
  ).join('') + '</ul>';
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token'); window.location = '/login.html';
});

document.getElementById('useCreditBtn').addEventListener('click', async () => {
  const r = await fetch('/api/credits/use', { method: 'POST', headers });
  const j = await r.json();
  if (!r.ok) { alert(j.message || 'Error'); return; }
  document.getElementById('creditsCount').innerText = j.credits;
  loadTransactions();
});

(async () => {
  await loadProfile();
  await loadTransactions();
})();
</script>
</body>
</html>
